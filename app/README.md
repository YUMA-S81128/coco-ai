# Coco-Ai フロントエンド (Flutter)

> Google Cloud Japan AI Hackathon vol.3 応募作品

このディレクトリは、親子対話 AI「Coco-Ai」のフロントエンドアプリケーションです。
Flutter (Web) を使用して構築されています。

## 役割

このアプリケーションは、ユーザー（親子）が直接操作するインターフェースを提供します。

- **UI/UX**: 子供向けのキャラクター（ココ、アイ）やイラストを表示し、楽しい対話体験を提供します。
- **音声入出力**: 子供の質問をマイクで受け付け、バックエンドから返ってきた解説を音声で再生します。
- **Firebase 連携**:
  - **Authentication**: ユーザー認証を行います。
  - **Cloud Functions**: 音声ファイルアップロードの開始時に、署名付き URL とジョブ ID を取得するために HTTPS Callable Function を呼び出します。
  - **Cloud Storage**: 取得した署名付き URL を使い、録音した音声ファイルを直接アップロードします。
  - **Firestore**: バックエンドの処理状況と結果（生成されたファイルのパスなど）をリアルタイムに監視（リッスン）します。

## 開発について

### 状態管理

このアプリケーションの状態管理には **Riverpod** を採用しています。
UI の状態（録音中、処理中、結果表示など）は `app/lib/providers/app_state_provider.dart` で定義された `AppStateNotifier` によって一元管理されます。
UI コンポーネントは `ConsumerWidget` を継承し、Provider を監視（watch）することで、状態の変更に応じてリアクティブに再描画されます。

### ディレクトリ構成 (`lib` 以下)

- `constants/`: アセットのパスや API のエンドポイントなど、アプリ全体で利用する定数を管理します。
- `models/`: アプリケーションの状態 (`AppState`) や、Firestore から取得するデータモデルを定義します。
- `providers/`: Riverpod の Provider を定義し、状態管理やビジネスロジックを記述します。
- `screens/`: アプリケーションの各画面を構成する UI ウィジェットを配置します。

## 開発フロー

### 1. 前提条件

- Flutter SDK がインストールされていること。
- Firebase CLI がインストール・設定されていること。

### 2. 依存関係のインストール

プロジェクトのルートディレクトリにある `app` フォルダに移動し、以下のコマンドを実行して必要なパッケージをインストールします。

```bash
# app ディレクトリに移動
cd app

# 依存パッケージをインストール
flutter pub get
```

### 3. ローカルでの動作確認

このアプリはバックエンド（Cloud Functions, Firestore, Storage）と連携します。
ローカルで開発する際は、**Firebase Emulator Suite** を使用することで、実際の Firebase サービスに接続することなく、オフラインで高速に開発を進めることができます。

#### 3.1. エミュレータの初期設定 (初回のみ)

まだ設定していない場合は、**プロジェクトのルートディレクトリ (`coco-ai/`)** で以下のコマンドを実行し、対話形式で設定を進めます。

```bash
# エミュレータの初期設定を開始
firebase init emulators
```

設定では、以下のエミュレータを選択してください。

- **Functions Emulator**
- **Firestore Emulator**
- **Storage Emulator**

ポート番号はデフォルトのままで問題ありません。

#### 3.2. エミュレータの起動

開発を開始する前に、プロジェクトのルートディレクトリで以下のコマンドを実行してエミュレータを起動します。

```bash
firebase emulators:start
```

ターミナルに `All emulators ready!` と表示されれば起動完了です。

> **Note:** 起動したエミュレータを停止するには、エミュレータが実行されているターミナルで `Ctrl + C` を押します。

#### 3.3. Flutter アプリの実行

`app` ディレクトリで以下のコマンドを実行し、Chrome でアプリを起動します。  
`--dart-define-from-file` オプションで Firebase の接続情報を渡すことが必須です。

デバッグモードで起動したアプリは、`lib/main.dart` の設定により自動的にローカルのエミュレータに接続します。

```bash
# ../config/dev.json にFirebaseの接続情報が保存されていると仮定
flutter run -d chrome --dart-define-from-file=../config/dev.json
```

    `--dart-define-from-file` で渡された設定により、アプリはどの Firebase プロジェクトに属しているかを認識し、その上でローカルのエミュレータに接続します。

> **Note:** このアプリケーションはバックエンドの保護に Firebase App Check (reCAPTCHA v3) を利用しています。ローカルで開発を行うには、`config/dev.json` に `RECAPTCHA_V3_SITE_KEY` を含めるだけでなく、Google Cloud reCAPTCHA 管理コンソールで、お使いのサイトキーの設定に `localhost` を許可ドメインとして追加する必要があります。

ホットリロード機能により、コードを保存するだけで変更が即座にアプリに反映されます。

> Note: 実行中のアプリを停止するには、アプリが実行されているターミナルで q キーを押します。

### 4. デプロイ

このアプリケーションは、プロジェクトルートの `cloudbuild.yaml` を介して、Cloud Build によって自動的に Firebase Hosting にデプロイされます。

デプロイプロセスの全体像については、プロジェクトルートの `README.md` を参照してください。

### 5. 依存関係の更新

プロジェクトで使用しているパッケージを更新する際は、以下の手順を推奨します。

1.  **更新の確認**:
    まず、どのパッケージに新しいバージョンがあるかを確認します。

    ```bash
    flutter pub outdated
    ```

2.  **安全な更新 (推奨)**:
    破壊的変更を含まない、マイナーバージョンおよびパッチバージョンのアップデートを適用します。これにより、既存のコードへの影響を最小限に抑えられます。

    ```bash
    flutter pub upgrade
    ```

3.  **メジャーバージョンの更新 (注意が必要)**:
    メジャーバージョンを更新する場合、API の変更によりコードの修正が必要になる可能性が高いです。`pubspec.yaml` のバージョン番号を直接編集し、`flutter pub get` を実行します。更新後は、各パッケージのマイグレーションガイドを確認し、十分なテストを行ってください。
