rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // 認証されたユーザーが、パスに含まれるuserIdと一致するかどうかを判定する共通関数
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // 各バケット内のファイルへのアクセスルール
    // ファイルパスは `{userId}/{jobId}/{fileName}` の形式を想定しており、
    // どのバケットでも、認証された所有者のみが読み取り可能です。
    // クライアントからの直接書き込みは、署名付きURLやバックエンド経由で行うため拒否します。
    match /{userId}/{jobId}/{allPaths=**} {
      allow read: if isOwner(userId);
      allow write: if false;
    }
  }
}
